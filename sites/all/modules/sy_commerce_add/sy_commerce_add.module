<?php

include_once('sy_commerce_add_functions.inc');
include_once('sy_commerce_add_block.inc');


function sy_commerce_add_menu() {
    $items = array();

    $items['change-sity'] = array(
        'page callback' => 'sy_commerce_add_change_sity',
        'page arguments' => array(1),
        'access callback' => TRUE,
        'type' => MENU_CALLBACK,
    );
    return $items;
}

function sy_commerce_add_ctools_plugin_directory($owner, $plugin_type){
    if ($owner == 'feeds_tamper' && $plugin_type == 'plugins') {
        return 'plugins';
    }
}

function sy_commerce_add_form_commerce_cart_add_to_cart_form_alter(&$form, &$form_state, $form_id)
{

    if(isset($form_state['context']['entity_id']) && $form_state['context']['view_mode']=='node_full' && isset($form_state['default_product']->type) && $form_state['default_product']->type=='product') {
        if (!isset($form_state['list_product_in_stok'])) $form_state['list_product_in_stok'] = sy_commerce_add_get_list_product_in_stocks($form_state['context']['entity_id']);
        $city_stocks = sy_commerce_add_get_city_stocks_in($form_state['list_product_in_stok']);
        $city_stocks_all = sy_commerce_add_get_city_stocks();
        $keys_location = array_keys($city_stocks_all);
        if(count($city_stocks_all)>0) {

            $form['#prefix'] = '<div id="cart-gip-form-wrapper">';
            $form['#suffix'] = '</div>';
            $form['fs_city'] = array(
                '#type' => 'fieldset',
                '#title' => 'Город',
                '#collapsible' => TRUE,
                '#collapsed' => FALSE,
            );

            if (isset($form_state['values']['city'])) {
                $def_city = $form_state['values']['city'];
            } elseif (isset($_SESSION['sy_commerce_add_city']) /* && array_key_exists($_SESSION['sy_commerce_add_city'], $city_stocks) */) {
                $def_city = $_SESSION['sy_commerce_add_city'];
            } else {
                $city_location = sy_commerce_add_get_city_stocks_location();
                if (is_string($city_location) && in_array($city_location, $city_stocks_all)) {
                    $def_city = $city_location;
                } else {
                    $def_city = $keys_location[0];
                }
            }
            dpm('-'.$def_city);
            $form['fs_city']['city'] = array(
                '#type' => 'select',
                '#title' => 'Город',
                '#default_value' => $def_city,
                '#options' => $city_stocks_all,
                '#ajax' => array(
                    'callback' => 'sy_commerce_add_city_choice_js',
                    'wrapper' => 'cart-gip-form-wrapper',
                    'method' => 'replace',
                    'effect' => 'fade',
                ),
            );
            $form['fs_city']['table']=sy_commerce_add_get_stocks_table($form_state['context']['entity_id']);
            if(array_key_exists($def_city, $city_stocks) ) {
                $options_product = sy_commerce_add_get_options_product($form_state['list_product_in_stok'], $def_city);
                $form['product_id']['#options'] = $options_product;
            }
            else
            {
                $form['city_information'] = array('#markup' => 'В этом городе нет', );
                $form['product_id']['#disabled'] = TRUE;
                $form['product_id']['#attributes']['style'] = 'display:none;';
                $form['quantity']['#disabled'] = TRUE;
                $form['submit']['#disabled'] = TRUE;
            }
        }
        else
        {
            $form['city_information'] = array('#markup' => 'Нет городов', );
        }

        /*
        $keys_product = array_keys($options_product);
        $form['product_id']['#default_value'] = $keys_product[0];
        $form_state['default_product'] = commerce_product_load($keys_product[0]);
        $form_state['values']['product_id'] = $keys_product[0];
        $form_state['input']['product_id'] = $keys_product[0];*/
    }
}

function sy_commerce_add_city_choice_js($form, &$form_state)
{
//    $_SESSION['sy_commerce_add_city'] = $form_state['values']['city'];
    $form_state['no_cache'] = TRUE;
    $form_state['rebuild'] = TRUE;
    return commerce_cart_add_to_cart_form_attributes_refresh($form, $form_state);

}

function sy_commerce_add_cron()
{
    $output = sy_commerce_add_get_orders_xml();
    file_unmanaged_save_data($output , drupal_realpath('public://feeds-tmp/output.xml'), FILE_EXISTS_REPLACE);
    sy_commerce_add_feeds_run();// 2 раза для прописи склада
    sy_commerce_add_feeds_run();// 2 раза для прописи склада
}

function sy_commerce_add_feeds_run() {
    $source=drupal_realpath('public://feeds-tmp/import.xml');
    $myFeed = feeds_source('import_catalog_pharm');
    $config = array('FeedsFileFetcher'=>array('source'=>$source));
    $myFeed->addConfig($config);
    while (FEEDS_BATCH_COMPLETE != $myFeed->import());
    $myFeed->state(FEEDS_FETCH);
    $myFeed->state(FEEDS_PROCESS);
    $myFeed->state(FEEDS_PROCESS_CLEAR);

    $myFeed = feeds_source('import_product_pharm');
    $config = array('FeedsFileFetcher'=>array('source'=>$source));
    $myFeed->addConfig($config);
    while (FEEDS_BATCH_COMPLETE != $myFeed->import());
    $myFeed->state(FEEDS_FETCH);
    $myFeed->state(FEEDS_PROCESS);
    $myFeed->state(FEEDS_PROCESS_CLEAR);


    $myFeed = feeds_source('import_display_product_pharm');
    $config = array('FeedsFileFetcher'=>array('source'=>$source));
    $myFeed->addConfig($config);
    while (FEEDS_BATCH_COMPLETE != $myFeed->import());
    $myFeed->state(FEEDS_FETCH);
    $myFeed->state(FEEDS_PROCESS);
    $myFeed->state(FEEDS_PROCESS_CLEAR);


}
function sy_commerce_add_get_orders_xml()
{
    $out='<?xml version="1.0" encoding="UTF-8" ?>'." \n";
    $oids = db_query("SELECT order_id FROM {commerce_order} WHERE status=:status", array(':status'=>'pending'))->fetchCol();
    $orders=commerce_order_load_multiple($oids);
    if(count($orders)>0) {
        $out .= "<commerce_orders> \n";
        foreach ($orders as $order) {
            $out .= "<commerce_order> \n";
            $out .= "<ID-order>$order->order_id</ID-order> \n";
            $out .= "<E-mail>$order->mail</E-mail> \n";
            $out .= "<Date-created>" . date("d/m/Y - H:i", $order->created) . "</Date-created> \n";
            $out .= "<Order-total>" . ($order->commerce_order_total['und'][0]['amount'] / 100) . "</Order-total> \n";
            $out .= "<list-products>" . sy_commerce_add_get_orders_xml_lines($order->order_id,$out) . "</list-products> \n";
            $out .= "</commerce_order> \n";
        }
        $out .= "</commerce_orders> \n";

        return $out;
    }
    else
    {
        return '';
    }
}
function sy_commerce_add_get_orders_xml_lines($order_id,&$out) {
    $oids = db_query("SELECT prd.title, prc.commerce_price_amount, prd.sku, cli.quantity, adqt.quantity as add_qty 
                    FROM {commerce_line_item} AS cli
                    LEFT JOIN {commerce_product} AS prd ON prd.sku = cli.line_item_label
                    LEFT JOIN {field_data_commerce_price} AS prc ON prc.entity_id = prd.product_id 
                    LEFT JOIN {sy_commerce_add_quantity} AS adqt ON adqt.line_item_id = cli.line_item_id  
                    WHERE cli.order_id = :order_id AND cli.type = 'product'",array(':order_id'=>$order_id));
    foreach ($oids as $key=>$val)
    {
        $out.="<product> \n";
        $out.="<name>$val->title</name> \n";
        $out.="<SKU>$val->sku</SKU> \n";
        $out.="<price>".($val->commerce_price_amount/100)."</price> \n";
        $out.="<qty>$val->quantity</qty> \n";
        $out.="<qty-add>".($val->add_qty!=0?$val->add_qty:0)."</qty-add> \n";
        $out.="</product> \n";
    }
}